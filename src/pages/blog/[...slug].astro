---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((entry) => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);

// Get all posts sorted by date (newest first) for prev/next navigation
const allPosts = (await getCollection('blog')).sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);

const currentIndex = allPosts.findIndex((p) => p.id === entry.id);
const prevPost = currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? allPosts[currentIndex - 1] : null;

const formattedDate = entry.data.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<BaseLayout
  title={entry.data.title + " | Moonbloom Farms"}
  description={entry.data.description}
>
  <article class="blog-post">
    <!-- Article Header -->
    <header class="post-header">
      <div class="post-header-inner">
        <time class="post-date" datetime={entry.data.date.toISOString()}>
          {formattedDate}
        </time>
        <h1 class="post-title">{entry.data.title}</h1>
        {entry.data.image && (
          <div class="post-hero-image" aria-label="Post hero image">
            <div class="post-hero-placeholder">
              <span class="post-hero-placeholder-text">Photo</span>
            </div>
          </div>
        )}
      </div>
    </header>

    <!-- Article Body (Markdown Content) -->
    <div class="post-body">
      <div class="prose">
        <Content />
      </div>
    </div>

    <!-- Post Navigation -->
    <nav class="post-nav" aria-label="Post navigation">
      <div class="post-nav-inner">
        <a href="/blog" class="post-nav-back">
          &larr; Back to all posts
        </a>

        <div class="post-nav-links">
          {prevPost && (
            <a href={`/blog/${prevPost.id}`} class="post-nav-link post-nav-prev">
              <span class="post-nav-label">Previous</span>
              <span class="post-nav-title">&larr; {prevPost.data.title}</span>
            </a>
          )}
          {nextPost && (
            <a href={`/blog/${nextPost.id}`} class="post-nav-link post-nav-next">
              <span class="post-nav-label">Next</span>
              <span class="post-nav-title">{nextPost.data.title} &rarr;</span>
            </a>
          )}
        </div>
      </div>
    </nav>
  </article>
</BaseLayout>

<style>
  /* ─── Article Wrapper ─── */
  .blog-post {
    padding-bottom: var(--space-2xl);
  }

  /* ─── Post Header ─── */
  .post-header {
    padding: var(--space-2xl) var(--space-md) var(--space-lg);
    text-align: center;
  }

  .post-header-inner {
    max-width: 720px;
    margin: 0 auto;
  }

  .post-date {
    display: block;
    font-family: var(--font-body);
    font-size: var(--font-size-sm);
    color: var(--color-charcoal-light);
    opacity: 0.7;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: var(--space-sm);
  }

  .post-title {
    font-family: var(--font-heading);
    font-size: clamp(2rem, 5vw, var(--font-size-4xl));
    font-weight: 700;
    line-height: 1.15;
    color: var(--color-charcoal);
    margin: 0;
  }

  /* ─── Hero Image Placeholder ─── */
  .post-hero-image {
    margin-top: var(--space-lg);
  }

  .post-hero-placeholder {
    width: 100%;
    aspect-ratio: 16 / 9;
    background-color: var(--color-cream-dark);
    border-radius: var(--border-radius);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .post-hero-placeholder-text {
    font-family: var(--font-body);
    font-size: var(--font-size-sm);
    color: var(--color-charcoal-light);
    text-transform: uppercase;
    letter-spacing: 0.15em;
    opacity: 0.5;
  }

  /* ─── Post Body / Prose ─── */
  .post-body {
    padding: 0 var(--space-md);
  }

  .prose {
    max-width: 720px;
    margin: 0 auto;
    font-family: var(--font-body);
    font-size: var(--font-size-lg);
    line-height: 1.8;
    color: var(--color-charcoal);
  }

  .prose :global(h2) {
    font-family: var(--font-heading);
    font-size: var(--font-size-2xl);
    font-weight: 700;
    color: var(--color-charcoal);
    margin-top: var(--space-xl);
    margin-bottom: var(--space-sm);
    line-height: 1.2;
  }

  .prose :global(h3) {
    font-family: var(--font-heading);
    font-size: var(--font-size-xl);
    font-weight: 700;
    color: var(--color-charcoal);
    margin-top: var(--space-lg);
    margin-bottom: var(--space-xs);
    line-height: 1.25;
  }

  .prose :global(p) {
    margin-top: 0;
    margin-bottom: var(--space-md);
  }

  .prose :global(blockquote) {
    margin: var(--space-lg) 0;
    padding: var(--space-sm) var(--space-md);
    border-left: 4px solid var(--color-terracotta);
    background-color: var(--color-cream-dark);
    border-radius: 0 var(--border-radius) var(--border-radius) 0;
    font-style: italic;
    color: var(--color-charcoal-light);
  }

  .prose :global(blockquote p) {
    margin-bottom: 0;
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin: var(--space-sm) 0 var(--space-md);
    padding-left: var(--space-md);
  }

  .prose :global(li) {
    margin-bottom: var(--space-xs);
  }

  .prose :global(ul li) {
    list-style-type: disc;
  }

  .prose :global(ol li) {
    list-style-type: decimal;
  }

  .prose :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: var(--border-radius);
    margin: var(--space-lg) 0;
  }

  .prose :global(a) {
    color: var(--color-forest);
    text-decoration: underline;
    text-underline-offset: 3px;
    transition: color var(--transition);
  }

  .prose :global(a:hover) {
    color: var(--color-terracotta);
  }

  .prose :global(strong) {
    font-weight: 700;
  }

  .prose :global(hr) {
    border: none;
    border-top: 1px solid var(--color-cream-dark);
    margin: var(--space-lg) 0;
  }

  /* ─── Post Navigation ─── */
  .post-nav {
    padding: var(--space-xl) var(--space-md) 0;
    border-top: 1px solid var(--color-cream-dark);
    margin-top: var(--space-xl);
  }

  .post-nav-inner {
    max-width: 720px;
    margin: 0 auto;
  }

  .post-nav-back {
    display: block;
    text-align: center;
    font-family: var(--font-body);
    font-size: var(--font-size-base);
    font-weight: 700;
    color: var(--color-forest);
    text-decoration: none;
    margin-bottom: var(--space-lg);
    transition: color var(--transition);
  }

  .post-nav-back:hover {
    color: var(--color-terracotta);
  }

  .post-nav-links {
    display: flex;
    justify-content: space-between;
    gap: var(--space-md);
  }

  .post-nav-link {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    text-decoration: none;
    flex: 1;
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--border-radius);
    background-color: var(--color-cream-dark);
    transition:
      background-color var(--transition),
      transform var(--transition);
  }

  .post-nav-link:hover {
    background-color: var(--color-white);
    transform: translateY(-2px);
  }

  .post-nav-prev {
    text-align: left;
  }

  .post-nav-next {
    text-align: right;
    margin-left: auto;
  }

  .post-nav-label {
    font-family: var(--font-body);
    font-size: var(--font-size-sm);
    color: var(--color-charcoal-light);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    opacity: 0.7;
  }

  .post-nav-title {
    font-family: var(--font-heading);
    font-size: var(--font-size-base);
    font-weight: 700;
    color: var(--color-forest);
    line-height: 1.3;
  }

  .post-nav-link:hover .post-nav-title {
    color: var(--color-terracotta);
  }

  /* ─── Responsive ─── */
  @media (max-width: 768px) {
    .post-header {
      padding: var(--space-xl) var(--space-sm) var(--space-md);
    }

    .post-body {
      padding: 0 var(--space-sm);
    }

    .post-nav {
      padding: var(--space-lg) var(--space-sm) 0;
    }

    .post-nav-links {
      flex-direction: column;
    }

    .post-nav-next {
      text-align: left;
      margin-left: 0;
    }
  }

  @media (max-width: 480px) {
    .post-header {
      padding: var(--space-lg) var(--space-sm) var(--space-sm);
    }

    .prose {
      font-size: var(--font-size-base);
    }
  }

  /* Respect reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .post-nav-link {
      transition: none;
    }
  }
</style>
